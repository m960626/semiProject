<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.mini.mapper.UserMapper">

	<!-- 마이페이지 정보 호출 -->
	<select id="selectMyPageUser" parameterType="hashmap" resultType="com.example.mini.model.User">
		SELECT NICK, ID, STATUS, GENDER
		FROM T2_USER
		WHERE ID = #{id}
	</select>
	
	<select id="selectMyClub" parameterType="hashmap" resultType="com.example.mini.model.User">
		select 
			id
		   ,C.cWin
		   ,cLose
		   ,cDraw
		   ,C.cNo
		   ,C.cName
		   ,R.cRank
		   ,IMGDATA
		from T2_CLUB C
		INNER JOIN T2_USER U ON C.CNO = U.CNO
		LEFT JOIN (
			select 
				cName
			   ,cWin 
			   ,@rownum := @rownum + 1 AS cRank
			from mini_db2.T2_CLUB C, 
				 (SELECT @rownum :=0) AS r
			order by cWin desc
		) R ON C.cName = R.cName
		LEFT JOIN mini_db2.T2_CIMG I ON I.cNo = C.cNo
		WHERE U.ID = #{sessionId}
	</select>
	
	<!-- 가입신청 정보 -->
	<select id="selectMyJoin" parameterType="hashmap" resultType="com.example.mini.model.User">
		select 
			cImg
		   ,C.cNo
		   ,cName
		   ,cStat
		   ,LOCNAME
		   ,cAge1
		   ,cAge2
		   ,cWin
		   ,close
		   ,cdraw
		   ,cGender
		   ,cDate
		   ,cnt
		   ,jNo
		   ,jStat
		   ,DelYn
		from mini_db2.T2_CLUBJOIN J
		inner join  mini_db2.T2_CLUB C ON J.CNO = C.CNO
		left join (
			select cNo, count(*) as cnt
			from mini_db2.T2_USER
			group by cNo
		)U ON U.CNO = J.CNO
		LEFT JOIN mini_db2.T2_LOC L ON C.CLOC = L.LOCNUM
		WHERE ID = #{sessionId};	
	</select>
	
	<update id="updateJoin" parameterType="hashmap">
		UPDATE mini_db2.T2_CLUBJOIN
		SET
			DelYn = 'Y'
		WHERE jNo = #{jNo}
	</update>
	
	<select id="selectClubRank" parameterType="hashmap" resultType="com.example.mini.model.User">
		<![CDATA[	
			select  B.cName, sum(sWin+sLose+sDraw) as total, round(sWin / (sWin+sLose) *100) as rate, sWin,  sLose, sDraw, locName, cAge1, cAge2
			from(
			select cName, sum(sWin) as sWin, sum(sLose) as sLose, sum(sDraw) as sDraw
			from(
			SELECT 
				cNo_H as cName,
				mDate,
				case when (score_h-score_a) > 0 then '1' else '0'
				  end as sWin, 
				 case when (score_h-score_a) < 0 then '1' else '0'
				  end as sLose,
				  case when (score_h-score_a) = 0 then'1' else '0'
				  end as sDraw
			FROM mini_db2.T2_MATCH
			WHERE mDate BETWEEN #{time1} AND #{time2} AND mStat = 4
			union
			SELECT 
				cNo_a as cName, 
				mDate,
				case when (score_h-score_a) < 0 then '1' else '0'
				  end as sWin, 
				 case when (score_h-score_a) > 0 then '1' else '0' 
				  end as sLose,
				  case when (score_h-score_a) = 0 then'1' else '0'
				  end as sDraw
			FROM mini_db2.T2_MATCH
			WHERE mDate BETWEEN #{time1} AND #{time2} AND mStat = 4
			) A
			group by cName
			) B 
			inner JOIN mini_db2.T2_CLUB C ON B.cName = C.cName
			inner join mini_db2.T2_LOC L ON L.locNum = C.cLoc
			group by B.cName 
			order by rate desc
		]]>
	</select>
	
	<select id="selectSoloRank" parameterType="hashmap" resultType="com.example.mini.model.User">
		<![CDATA[	
			select A.id, sum(mgoal) as sgoal, nick, addr, birth
			from(
			select 
				id,
			    mgoal
			from mini_db2.T2_MATCH M
			inner join  mini_db2.T2_MATCHP P ON P.MNO = M.MNO
			where mDate between #{time1} AND #{time2} AND mStat = 4
			) A
			inner join mini_db2.T2_USER U ON U.ID = A.ID
			group by A.id
			order by mgoal desc
		]]>
	</select>
	
	<!-- 최근기록 정보 -->
	<select id="selectMyInfo" parameterType="hashmap" resultType="com.example.mini.model.User">
		SELECT U.id, name, nick, gender, position1, position2, position3, cImg, C.cName, ranking, cWin, cLose, cDraw, rate, ifnull(mgoal, 0) AS mgoal, ifnull(massi, 0) AS massi, ifnull(myCard, 0) AS myCard, ifnull(mrCard, 0) AS mrCard, ifnull(mCnt, 0) AS mCnt
		FROM mini_db2.T2_USER U
		LEFT JOIN mini_db2.T2_CLUB C ON C.cNo = U.cNo
		LEFT JOIN (
			SELECT row_number() over(order by rate desc) as ranking, cName, rate
			FROM (
				SELECT  cName, IFNULL(ROUND(cWin / (cWin + cLose)*100),0) AS rate
				FROM mini_db2.T2_CLUB 
				GROUP BY cName
			) A 
		) A ON A.cName = C.cName
		LEFT JOIN (
			SELECT P.id AS id, sum(mgoal) as mgoal, sum(massi) as massi, sum(myCard) as myCard, sum(mrCard) as mrCard, mCnt
			FROM mini_db2.T2_MATCHP P
			inner join (
				SELECT id, COUNT(*) AS mCnt
				FROM mini_db2.T2_MATCH M
				INNER JOIN mini_db2.T2_MATCHP P ON P.mNo = M.mNo
				GROUP BY id
			) A ON A.id = P.id
			GROUP BY P.id
		) B ON B.id = U.id
		WHERE U.id = #{sessionId}
	</select>
</mapper>